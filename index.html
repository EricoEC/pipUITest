<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画中画测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            min-height: 100vh;
            background-color: #1a1a1a;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        /* 主页面数字滚动容器（文献2、5：需克隆到PiP窗口） */
        .number-container {
            font-size: 5rem;
            font-weight: 700;
            color: #00e5ff;
            text-shadow: 0 0 25px rgba(0, 229, 255, 0.6);
            margin-bottom: 60px;
            letter-spacing: -0.1rem;
            padding: 30px 50px;
            border-radius: 16px;
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(0, 229, 255, 0.3);
        }
        /* 画中画切换按钮（文献3：需用户交互触发） */
        .pip-btn {
            padding: 14px 32px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1a;
            background-color: #00e5ff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 229, 255, 0.4);
        }
        .pip-btn:hover {
            background-color: #00c8e6;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 229, 255, 0.6);
        }
        /* 兼容性提示（文献1、4：浏览器支持检测） */
        .support-tip {
            position: fixed;
            bottom: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }
        /* PiP窗口样式同步（文献2、5：克隆样式表） */
        .pip-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1a1a1a;
        }
    </style>
</head>
<body>
    <!-- 数字滚动容器（核心内容，将被克隆到PiP窗口） -->
    <div class="number-container" id="numberContainer">
        <span id="rollingNumber">1234512345</span>
    </div>

    <!-- 画中画切换按钮（用户交互触发，文献3） -->
    <button class="pip-btn" id="pipToggleBtn">切换画中画模式</button>

    <!-- 兼容性提示 -->
    <div class="support-tip" id="supportTip">提示：请使用Chrome 99+/Edge 98+浏览器以支持画中画功能</div>

    <script>
        // 1. 浏览器画中画支持检测（文献1、4：Document Picture-in-Picture API）
        const isPiPSupported = 'documentPictureInPicture' in window;
        const pipToggleBtn = document.getElementById('pipToggleBtn');
        const supportTip = document.getElementById('supportTip');
        const numberContainer = document.getElementById('numberContainer');
        const rollingNumber = document.getElementById('rollingNumber');
        let pipWindow = null; // 存储画中画窗口实例
        let pipContentClone = null; // 存储克隆的数字容器（文献2、5：避免DOM移动）

        // 不支持时禁用按钮并提示
        if (!isPiPSupported) {
            pipToggleBtn.disabled = true;
            pipToggleBtn.textContent = '浏览器不支持画中画';
            supportTip.style.color = 'rgba(255, 99, 71, 0.7)';
            supportTip.textContent = '当前浏览器不支持画中画，请更新Chrome/Edge到最新版本';
        }

        // 2. 12345数字实时滚动逻辑（核心需求：无快进/跳播，实时更新）
        const baseNumber = '12345';
        let currentIndex = 0;
        // 定时器控制滚动（主页面+画中画共享同一定时器，确保同步）
        const rollNumberTimer = setInterval(() => {
            currentIndex = (currentIndex + 1) % baseNumber.length;
            // 生成10位重复滚动的数字（如1234512345→2345123451）
            const rolledNumber = baseNumber.slice(currentIndex) + baseNumber.repeat(3).slice(0, 10 - baseNumber.slice(currentIndex).length);
            rollingNumber.textContent = rolledNumber;
            // 同步更新画中画窗口的数字（文献2、5：实时内容联动）
            if (pipContentClone) {
                const pipNumber = pipContentClone.querySelector('#rollingNumber');
                if (pipNumber) pipNumber.textContent = rolledNumber;
            }
        }, 300); // 300ms滚动一次，速度适中

        // 3. 画中画模式切换核心逻辑（文献2、4、5：Document PiP API实操）
        pipToggleBtn.addEventListener('click', async () => {
            try {
                // 已开启画中画：退出并恢复内容
                if (document.documentPictureInPicture.window) {
                    document.documentPictureInPicture.window.close();
                    pipContentClone = null;
                    pipToggleBtn.textContent = '切换画中画模式';
                    return;
                }

                // 未开启画中画：创建窗口（文献4：requestWindow()异步方法）
                pipWindow = await window.documentPictureInPicture.requestWindow({
                    width: 300,  // 画中画窗口宽度（文献2建议：适配移动/桌面）
                    height: 180  // 画中画窗口高度
                });

                // 克隆数字容器到画中画窗口（文献5：避免原DOM被移除）
                pipContentClone = numberContainer.cloneNode(true);
                pipContentClone.classList.add('pip-content'); // 适配画中画样式
                pipWindow.document.body.appendChild(pipContentClone);

                // 同步主页面样式到画中画窗口（文献2、5：styleSheets克隆）
                [...document.styleSheets].forEach(styleSheet => {
                    try {
                        // 内联样式直接复制（无跨域问题）
                        const cssRules = [...styleSheet.cssRules].map(rule => rule.cssText).join('');
                        const style = document.createElement('style');
                        style.textContent = cssRules;
                        pipWindow.document.head.appendChild(style);
                    } catch (e) {
                        // 外部样式用link引入（处理跨域场景，文献5）
                        if (styleSheet.href) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = styleSheet.href;
                            pipWindow.document.head.appendChild(link);
                        }
                    }
                });

                // 监听画中画窗口关闭事件（文献4：pagehide事件）
                pipWindow.addEventListener('pagehide', () => {
                    pipContentClone = null;
                    pipToggleBtn.textContent = '切换画中画模式';
                });

                // 更新按钮文本
                pipToggleBtn.textContent = '退出画中画模式';
            } catch (error) {
                console.error('画中画操作失败：', error);
                alert('画中画开启失败，请重试或更新浏览器');
            }
        });

        // 4. 页面关闭时清理定时器（避免内存泄漏）
        window.addEventListener('beforeunload', () => {
            clearInterval(rollNumberTimer);
            if (pipWindow) pipWindow.close();
        });
    </script>
</body>
</html>
